<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CMHC Multi-Unit Policy Assistant</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--primary:#0a5e6c;--primary-light:#0d7a8c;--primary-dark:#084a55;--accent:#00b4d8;--bg:#f0f4f8;--surface:#fff;--text:#1a2332;--text-light:#5a6577;--border:#e2e8f0;--msg-user:#0a5e6c;--msg-bot:#f7fafc;--sidebar-w:320px}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;overflow:hidden}
.header{background:linear-gradient(135deg,var(--primary),var(--primary-light));color:#fff;padding:16px 24px;display:flex;align-items:center;gap:16px;box-shadow:0 2px 12px rgba(0,0,0,.15);z-index:10}
.header .logo{width:44px;height:44px;background:rgba(255,255,255,.15);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0}
.header h1{font-size:20px;font-weight:700;letter-spacing:-.3px}
.header p{font-size:13px;opacity:.85;margin-top:2px}
.hamburger{display:none;background:none;border:none;color:#fff;font-size:26px;cursor:pointer;padding:4px 8px}
.main{display:flex;flex:1;overflow:hidden}
.sidebar{width:var(--sidebar-w);background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;overflow-y:auto}
.sidebar-header{padding:20px 20px 12px;font-size:13px;font-weight:600;color:var(--text-light);text-transform:uppercase;letter-spacing:.5px}
.topic-btn{display:flex;align-items:center;gap:12px;padding:12px 20px;border:none;background:none;text-align:left;font-size:14px;color:var(--text);cursor:pointer;transition:all .15s;width:100%;border-left:3px solid transparent}
.topic-btn:hover{background:#f0f7fa;border-left-color:var(--accent)}
.topic-btn .icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.topic-btn:nth-child(odd) .icon{background:#e8f6f8;color:var(--primary)}
.topic-btn:nth-child(even) .icon{background:#fff3e0;color:#e65100}
.chat-area{flex:1;display:flex;flex-direction:column;min-width:0}
.messages{flex:1;overflow-y:auto;padding:24px;display:flex;flex-direction:column;gap:16px}
.msg{max-width:780px;line-height:1.65;animation:fadeIn .3s}
.msg.user{align-self:flex-end;background:var(--msg-user);color:#fff;padding:14px 20px;border-radius:18px 18px 4px 18px;font-size:15px}
.msg.bot{align-self:flex-start;background:var(--msg-bot);border:1px solid var(--border);padding:18px 22px;border-radius:4px 18px 18px 18px;font-size:15px;width:100%}
.msg.bot h1,.msg.bot h2,.msg.bot h3{margin:16px 0 8px;color:var(--primary)}
.msg.bot h1{font-size:18px}.msg.bot h2{font-size:16px}.msg.bot h3{font-size:15px}
.msg.bot p{margin:6px 0}.msg.bot ul,.msg.bot ol{margin:6px 0 6px 20px}
.msg.bot li{margin:4px 0}
.msg.bot strong{color:var(--primary-dark)}
.msg.bot table{border-collapse:collapse;margin:12px 0;width:100%;font-size:13px}
.msg.bot th{background:var(--primary);color:#fff;padding:8px 12px;text-align:left}
.msg.bot td{padding:8px 12px;border-bottom:1px solid var(--border)}
.msg.bot tr:nth-child(even){background:#f8fafc}
.msg.bot code{background:#edf2f7;padding:2px 6px;border-radius:4px;font-size:13px}
.welcome{text-align:center;padding:60px 24px;color:var(--text-light);align-self:center}
.welcome h2{color:var(--primary);font-size:24px;margin-bottom:8px}
.welcome p{font-size:15px;max-width:500px;margin:0 auto}
.typing{display:flex;gap:5px;padding:18px 22px;align-self:flex-start}
.typing span{width:8px;height:8px;background:var(--accent);border-radius:50%;animation:bounce .6s infinite alternate}
.typing span:nth-child(2){animation-delay:.2s}.typing span:nth-child(3){animation-delay:.4s}
@keyframes bounce{to{opacity:.3;transform:translateY(-6px)}}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
.input-area{padding:16px 24px;background:var(--surface);border-top:1px solid var(--border)}
.input-wrap{display:flex;gap:12px;max-width:820px;margin:0 auto}
.input-wrap textarea{flex:1;padding:14px 18px;border:2px solid var(--border);border-radius:14px;font-size:15px;font-family:inherit;resize:none;outline:none;transition:border-color .2s;min-height:52px;max-height:120px}
.input-wrap textarea:focus{border-color:var(--accent)}
.send-btn{width:52px;height:52px;border-radius:14px;border:none;background:var(--primary);color:#fff;font-size:20px;cursor:pointer;transition:background .2s;flex-shrink:0}
.send-btn:hover{background:var(--primary-light)}
.send-btn:disabled{background:var(--border);cursor:not-allowed}
.disclaimer{text-align:center;padding:8px;font-size:11px;color:var(--text-light);background:var(--surface);border-top:1px solid var(--border)}
.login-overlay{position:fixed;inset:0;background:linear-gradient(135deg,#0a5e6c,#0d7a8c);z-index:100;display:flex;align-items:center;justify-content:center}
.login-box{background:#fff;border-radius:20px;padding:48px;max-width:420px;width:90%;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.3)}
.login-box .logo-big{font-size:48px;margin-bottom:16px}
.login-box h2{color:var(--primary);margin-bottom:8px;font-size:22px}
.login-box p{color:var(--text-light);margin-bottom:24px;font-size:14px}
.login-box input{width:100%;padding:14px 18px;border:2px solid var(--border);border-radius:12px;font-size:16px;outline:none;margin-bottom:16px;text-align:center;letter-spacing:2px}
.login-box input:focus{border-color:var(--accent)}
.login-box button{width:100%;padding:14px;border:none;border-radius:12px;background:var(--primary);color:#fff;font-size:16px;font-weight:600;cursor:pointer;transition:background .2s}
.login-box button:hover{background:var(--primary-light)}
.login-error{color:#e53e3e;font-size:13px;margin-top:8px;display:none}
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:19}
@media(max-width:768px){
  .sidebar{position:fixed;left:0;top:0;bottom:0;z-index:20;transform:translateX(-100%);transition:transform .3s}
  .sidebar.open{transform:translateX(0)}
  .sidebar-overlay.open{display:block}
  .hamburger{display:block}
  .header h1{font-size:17px}
  .messages{padding:16px}
}
</style>
</head>
<body>
<div class="login-overlay" id="loginOverlay">
  <div class="login-box">
    <div class="logo-big">üè¢</div>
    <h2>CMHC Policy Assistant</h2>
    <p>Enter access code to continue</p>
    <input type="password" id="loginPassword" placeholder="Access Code" onkeydown="if(event.key==='Enter')doLogin()">
    <button onclick="doLogin()">Enter</button>
    <div class="login-error" id="loginError">Invalid access code. Please try again.</div>
  </div>
</div>
<div class="header">
  <button class="hamburger" onclick="toggleSidebar()">‚ò∞</button>
  <div class="logo">üè¢</div>
  <div>
    <h1>CMHC Multi-Unit Policy Assistant</h1>
    <p>Instant answers on multi-unit mortgage insurance & ACLP</p>
  </div>
</div>
<div class="main">
  <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">Common Topics</div>
    <button class="topic-btn" onclick="askTopic(this)" data-q="What are the eligibility requirements for CMHC multi-unit mortgage loan insurance? What property types qualify, what are the minimum unit requirements, and what are the borrower requirements?"><div class="icon">‚úì</div><span>Eligibility Requirements</span></button>
    <button class="topic-btn" onclick="askTopic(this)" data-q="What are the current CMHC multi-unit insurance premium rates? Please show the full premium rate tables for both Standard Rental Housing and All Other Shelter Models, including construction financing rates and surcharges."><div class="icon">üí∞</div><span>Premium Rates & Calculation</span></button>
    <button class="topic-btn" onclick="askTopic(this)" data-q="What are the maximum loan-to-value (LTV) ratios for CMHC multi-unit mortgage insurance? How do they differ between Market Rental and MLI Select, and between purchase, refinance, and construction?"><div class="icon">üìä</div><span>Maximum LTV Ratios</span></button>
    <button class="topic-btn" onclick="askTopic(this)" data-q="What documents are required for a CMHC multi-unit mortgage insurance application? Please provide the full documentation checklist including financial, property, project planning, legal, and environmental requirements."><div class="icon">üìã</div><span>Documentation Checklist</span></button>
    <button class="topic-btn" onclick="askTopic(this)" data-q="How does CMHC multi-unit insurance differ for rental properties versus condominium projects? What are the key considerations for each type?"><div class="icon">üèòÔ∏è</div><span>Rental vs Condo Projects</span></button>
    <button class="topic-btn" onclick="askTopic(this)" data-q="How does CMHC construction financing work for multi-unit properties? What are the premium rates, LTV limits, process, and required documentation for construction loans?"><div class="icon">üèóÔ∏è</div><span>Construction Financing</span></button>
    <button class="topic-btn" onclick="askTopic(this)" data-q="What affordable housing incentives does CMHC offer through its multi-unit programs? How does the MLI Select affordability scoring work, and what programs like ACLP complement it?"><div class="icon">üè†</div><span>Affordable Housing Incentives</span></button>
    <button class="topic-btn" onclick="askTopic(this)" data-q="What are the CMHC rules for refinancing multi-unit properties? What are the maximum LTV ratios, premium rates, eligible purposes, and special rules for affordable housing refinancing?"><div class="icon">üîÑ</div><span>Refinancing Rules</span></button>
    <button class="topic-btn" onclick="askTopic(this)" data-q="What are the typical processing timelines for CMHC multi-unit mortgage insurance applications? What factors affect processing time and how can I expedite the process?"><div class="icon">‚è±Ô∏è</div><span>Processing Timelines</span></button>
    <button class="topic-btn" onclick="askTopic(this)" data-q="What are CMHC's environmental requirements for multi-unit mortgage insurance? What Phase I and Phase II ESA requirements apply, and what energy efficiency standards are expected?"><div class="icon">üåø</div><span>Environmental Requirements</span></button>
    <button class="topic-btn" onclick="askTopic(this)" data-q="What is the CMHC MLI Select program? How does the points-based system work for affordability, energy efficiency, and accessibility? What are the premium discounts and other benefits?"><div class="icon">‚≠ê</div><span>MLI Select Program</span></button>
    <button class="topic-btn" onclick="askTopic(this)" data-q="What are the most recent changes to CMHC multi-unit mortgage insurance policies in 2025? What changed with Advice 263 and 264, and how do the new premium structures work?"><div class="icon">üì∞</div><span>2025 Policy Changes</span></button>
    <div class="sidebar-header">ACLP Program</div>
    <button class="topic-btn" onclick="askTopic(this)" data-q="What is the CMHC Apartment Construction Loan Program (ACLP)? How does it work, what does it offer, and what types of projects does it fund? Please provide a comprehensive overview."><div class="icon">üèóÔ∏è</div><span>ACLP Overview</span></button>
    <button class="topic-btn" onclick="askTopic(this)" data-q="What are the eligibility requirements for the CMHC ACLP program? Who can apply, what project types qualify, and what are the affordability requirements? Include details on student housing and seniors housing eligibility."><div class="icon">‚úì</div><span>ACLP Eligibility</span></button>
    <button class="topic-btn" onclick="askTopic(this)" data-q="What are the ACLP loan terms, interest rates, and financial details? What is the maximum loan amount, loan-to-cost ratio, amortization period, and how are interest rates determined?"><div class="icon">üí∞</div><span>ACLP Terms & Rates</span></button>
    <button class="topic-btn" onclick="askTopic(this)" data-q="What is the ACLP application process? What are the steps, required documentation, timeline, and tips for a strong application? Include details on the scoring system and Frequent Builder framework."><div class="icon">üìã</div><span>ACLP Application Process</span></button>
    <button class="topic-btn" onclick="askTopic(this)" data-q="How does the CMHC ACLP compare to standard Multi-Unit Mortgage Loan Insurance (MU MLI) and MLI Select? When should a developer use each program, and how do they complement each other?"><div class="icon">‚öñÔ∏è</div><span>ACLP vs MU MLI vs MLI Select</span></button>
  </aside>
  <div class="chat-area">
    <div class="messages" id="messages">
      <div class="welcome">
        <h2>Welcome, Broker</h2>
        <p>Ask me anything about CMHC multi-unit mortgage loan insurance, MLI Select, or the Apartment Construction Loan Program (ACLP) ‚Äî eligibility, premiums, LTV ratios, documentation, and more.</p>
      </div>
    </div>
    <div class="input-area">
      <div class="input-wrap">
        <textarea id="input" placeholder="Ask about CMHC multi-unit policies..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();send()}"></textarea>
        <button class="send-btn" id="sendBtn" onclick="send()">‚û§</button>
      </div>
    </div>
    <div class="disclaimer">‚ö†Ô∏è This tool provides information based on publicly available CMHC documentation. Always verify with CMHC directly for official policy decisions. Not legal or financial advice.</div>
  </div>
</div>
<script>
const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
  ? '' : 'http://178.156.217.249:3456';
const msgs=document.getElementById('messages'),input=document.getElementById('input'),sendBtn=document.getElementById('sendBtn');
let history=[],streaming=false,authToken=sessionStorage.getItem('cmhc_token')||'';

// Auto-login if token exists
if(authToken) document.getElementById('loginOverlay').style.display='none';

async function doLogin(){
  const pw=document.getElementById('loginPassword').value;
  try{
    const res=await fetch(API_BASE+'/api/auth',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({password:pw})});
    const data=await res.json();
    if(data.ok){
      authToken=data.token;
      sessionStorage.setItem('cmhc_token',authToken);
      document.getElementById('loginOverlay').style.display='none';
      document.getElementById('loginError').style.display='none';
    }else{
      document.getElementById('loginError').style.display='block';
    }
  }catch(e){
    document.getElementById('loginError').textContent='Connection error. Please try again.';
    document.getElementById('loginError').style.display='block';
  }
}

function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('open');
  document.querySelector('.sidebar-overlay').classList.toggle('open');
}
function askTopic(btn){
  toggleSidebar();
  input.value=btn.dataset.q;
  send();
}
function addMsg(role,html){
  const d=document.createElement('div');
  d.className='msg '+role;
  d.innerHTML=html;
  // Remove welcome
  const w=msgs.querySelector('.welcome');
  if(w)w.remove();
  msgs.appendChild(d);
  msgs.scrollTop=msgs.scrollHeight;
  return d;
}
function showTyping(){
  const d=document.createElement('div');
  d.className='typing';d.id='typing';
  d.innerHTML='<span></span><span></span><span></span>';
  msgs.appendChild(d);msgs.scrollTop=msgs.scrollHeight;
}
function hideTyping(){const t=document.getElementById('typing');if(t)t.remove();}

// Simple markdown renderer
function md(text){
  // tables
  text=text.replace(/^\|(.+)\|\s*\n\|[-| :]+\|\s*\n((\|.+\|\s*\n?)*)/gm,(m,hdr,body)=>{
    const ths=hdr.split('|').map(c=>`<th>${c.trim()}</th>`).join('');
    const rows=body.trim().split('\n').map(r=>{
      const tds=r.replace(/^\||\|$/g,'').split('|').map(c=>`<td>${c.trim()}</td>`).join('');
      return `<tr>${tds}</tr>`;
    }).join('');
    return `<table><thead><tr>${ths}</tr></thead><tbody>${rows}</tbody></table>`;
  });
  text=text.replace(/^### (.+)$/gm,'<h3>$1</h3>');
  text=text.replace(/^## (.+)$/gm,'<h2>$1</h2>');
  text=text.replace(/^# (.+)$/gm,'<h1>$1</h1>');
  text=text.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  text=text.replace(/\*(.+?)\*/g,'<em>$1</em>');
  text=text.replace(/`(.+?)`/g,'<code>$1</code>');
  // lists
  text=text.replace(/^(\s*)[-‚Ä¢] (.+)$/gm,'$1<li>$2</li>');
  text=text.replace(/(<li>.*<\/li>\n?)+/gs,m=>'<ul>'+m+'</ul>');
  text=text.replace(/^\d+\. (.+)$/gm,'<li>$1</li>');
  // paragraphs
  text=text.replace(/\n{2,}/g,'</p><p>');
  text='<p>'+text+'</p>';
  text=text.replace(/<p>\s*(<[hultHULT])/g,'$1');
  text=text.replace(/(<\/[hultHULT][^>]*>)\s*<\/p>/g,'$1');
  return text;
}

async function send(){
  const text=input.value.trim();
  if(!text||streaming)return;
  streaming=true;
  sendBtn.disabled=true;
  input.value='';
  input.style.height='auto';

  addMsg('user',text.replace(/</g,'&lt;'));
  history.push({role:'user',content:text});
  showTyping();

  let fullText='';
  const botMsg=document.createElement('div');
  botMsg.className='msg bot';

  try{
    const res=await fetch(API_BASE+'/api/chat',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+authToken},
      body:JSON.stringify({message:text,history:history.slice(-10)})
    });
    hideTyping();
    msgs.appendChild(botMsg);

    const reader=res.body.getReader();
    const dec=new TextDecoder();
    let buf='';
    while(true){
      const{done,value}=await reader.read();
      if(done)break;
      buf+=dec.decode(value,{stream:true});
      const lines=buf.split('\n');
      buf=lines.pop();
      for(const line of lines){
        if(line.startsWith('data: ')){
          const d=line.slice(6);
          if(d==='[DONE]')continue;
          try{
            const j=JSON.parse(d);
            if(j.text){fullText+=j.text;botMsg.innerHTML=md(fullText);msgs.scrollTop=msgs.scrollHeight;}
            if(j.error){botMsg.innerHTML='<p>‚ö†Ô∏è '+j.error+'</p>';}
          }catch{}
        }
      }
    }
    history.push({role:'assistant',content:fullText});
  }catch(e){
    hideTyping();
    addMsg('bot','<p>‚ö†Ô∏è Connection error. Please try again.</p>');
  }
  streaming=false;
  sendBtn.disabled=false;
  input.focus();
}

// Auto-resize textarea
input.addEventListener('input',()=>{input.style.height='auto';input.style.height=Math.min(input.scrollHeight,120)+'px';});
</script>
</body>
</html>
