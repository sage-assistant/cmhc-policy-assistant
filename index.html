<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CMHC Policy Assistant</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
--bg:#06080f;--surface:#0d1220;--surface-el:#141e33;
--grad:linear-gradient(135deg,#10b981,#0ea5e9);
--accent:#10b981;--accent2:#0ea5e9;
--text:#e2e8f0;--text2:#64748b;--text3:#334155;
--border:#1e293b;--err:#ef4444;
--font:'Inter',system-ui,-apple-system,sans-serif;
}
html,body{height:100%;font-family:var(--font);background:var(--bg);color:var(--text);overflow:hidden;-webkit-font-smoothing:antialiased}
::selection{background:rgba(16,185,129,.3);color:#fff}
::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(16,185,129,.25);border-radius:5px}
::-webkit-scrollbar-thumb:hover{background:rgba(16,185,129,.4)}

/* ===== NOISE TEXTURE ===== */
.noise{position:fixed;inset:0;pointer-events:none;z-index:0;opacity:.035;
background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
background-repeat:repeat;background-size:200px 200px}

/* ===== DOT GRID ===== */
.dotgrid{position:fixed;inset:0;pointer-events:none;z-index:0;opacity:.04;
background-image:radial-gradient(circle,rgba(226,232,240,.5) 1px,transparent 1px);
background-size:24px 24px}

/* ===== ANIMATED GRADIENT ORBS ===== */
.orb{position:fixed;border-radius:50%;filter:blur(100px);pointer-events:none;z-index:0}
.orb1{width:600px;height:600px;top:-200px;left:-100px;background:rgba(16,185,129,.07);animation:orbFloat 20s ease-in-out infinite}
.orb2{width:500px;height:500px;bottom:-150px;right:-100px;background:rgba(14,165,233,.06);animation:orbFloat 25s ease-in-out infinite reverse}
.orb3{width:350px;height:350px;top:40%;left:60%;background:rgba(16,185,129,.04);animation:orbFloat 18s ease-in-out infinite 5s}
@keyframes orbFloat{0%,100%{transform:translate(0,0)}25%{transform:translate(30px,-40px)}50%{transform:translate(-20px,30px)}75%{transform:translate(40px,20px)}}

/* ===== LOGIN ===== */
#login{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:100;background:var(--bg);transition:opacity .6s cubic-bezier(.4,0,.2,1),visibility .6s}
#login.hidden{opacity:0;visibility:hidden;pointer-events:none}

.login-card{position:relative;text-align:center;max-width:400px;width:90%;padding:48px 40px;
background:rgba(13,18,32,.6);backdrop-filter:blur(40px);-webkit-backdrop-filter:blur(40px);
border:1px solid rgba(30,41,59,.5);border-radius:24px;
box-shadow:0 0 80px rgba(16,185,129,.05),0 25px 50px rgba(0,0,0,.4);
animation:cardIn .8s cubic-bezier(.4,0,.2,1)}
@keyframes cardIn{from{opacity:0;transform:translateY(20px) scale(.97)}to{opacity:1;transform:translateY(0) scale(1)}}

.login-icon{width:64px;height:64px;margin:0 auto 28px;border-radius:18px;display:flex;align-items:center;justify-content:center;
background:var(--grad);box-shadow:0 8px 32px rgba(16,185,129,.25);position:relative;overflow:hidden}
.login-icon::after{content:'';position:absolute;inset:0;background:linear-gradient(180deg,rgba(255,255,255,.15),transparent);border-radius:18px}
.login-icon svg{width:32px;height:32px;fill:#fff;position:relative;z-index:1}

.login-title{font-size:24px;font-weight:700;letter-spacing:-.5px;margin-bottom:8px;color:var(--text)}
.login-tagline{font-size:14px;font-weight:300;color:var(--text2);line-height:1.6;margin-bottom:36px}

.input-wrap{position:relative;margin-bottom:16px}
.input-wrap input{width:100%;padding:16px 20px;background:rgba(6,8,15,.6);border:1px solid var(--border);
border-radius:14px;color:var(--text);font-family:var(--font);font-size:15px;outline:none;
transition:border .3s,box-shadow .3s}
.input-wrap input:focus{border-color:rgba(16,185,129,.5);box-shadow:0 0 0 3px rgba(16,185,129,.1)}
.input-wrap input::placeholder{color:var(--text3);font-weight:300}
.input-wrap label{position:absolute;left:20px;top:16px;font-size:15px;color:var(--text3);font-weight:300;
pointer-events:none;transition:all .25s cubic-bezier(.4,0,.2,1)}
.input-wrap input:focus~label,.input-wrap input:not(:placeholder-shown)~label{
top:-10px;left:14px;font-size:11px;font-weight:500;color:var(--accent);
background:var(--surface);padding:2px 8px;border-radius:4px}

.login-btn{width:100%;padding:16px;border:none;border-radius:14px;font-family:var(--font);font-size:15px;
font-weight:600;color:#fff;cursor:pointer;transition:all .3s;position:relative;overflow:hidden;
background:var(--grad);box-shadow:0 4px 20px rgba(16,185,129,.2)}
.login-btn:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(16,185,129,.3)}
.login-btn:active{transform:translateY(0)}
.login-btn::after{content:'';position:absolute;inset:0;background:linear-gradient(180deg,rgba(255,255,255,.1),transparent);pointer-events:none}

.login-error{color:var(--err);font-size:13px;margin-top:14px;min-height:20px;font-weight:400;transition:opacity .3s}

.login-badge{margin-top:32px;font-size:11px;font-weight:400;color:var(--text3);letter-spacing:.5px;text-transform:uppercase;
display:flex;align-items:center;justify-content:center;gap:6px}
.login-badge::before{content:'';width:6px;height:6px;border-radius:50%;background:var(--accent);animation:badgePulse 2s ease-in-out infinite}
@keyframes badgePulse{0%,100%{opacity:.4}50%{opacity:1}}

/* ===== APP SHELL ===== */
#app{display:none;height:100%;flex-direction:column;position:relative;z-index:1}
#app.active{display:flex}

/* NAV */
.nav{height:60px;padding:0 24px;display:flex;align-items:center;justify-content:space-between;
background:rgba(13,18,32,.7);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
border-bottom:1px solid rgba(30,41,59,.4);flex-shrink:0;position:relative;z-index:10}
.nav-left{display:flex;align-items:center;gap:12px}
.nav-logo{width:34px;height:34px;border-radius:10px;background:var(--grad);display:flex;align-items:center;justify-content:center;
box-shadow:0 2px 12px rgba(16,185,129,.2)}
.nav-logo svg{width:18px;height:18px;fill:#fff}
.nav-brand{font-size:15px;font-weight:600;letter-spacing:-.2px}
.nav-right{display:flex;align-items:center;gap:12px}
.nav-btn{padding:8px 18px;border:1px solid var(--border);border-radius:10px;background:transparent;
color:var(--text);font-family:var(--font);font-size:13px;font-weight:500;cursor:pointer;
transition:all .25s;display:flex;align-items:center;gap:6px}
.nav-btn:hover{background:rgba(16,185,129,.08);border-color:rgba(16,185,129,.3)}
.nav-btn svg{width:14px;height:14px;fill:currentColor}
.avatar{width:34px;height:34px;border-radius:50%;background:var(--surface-el);border:1px solid var(--border);
display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:600;color:var(--text2)}

/* CHAT AREA */
.chat-wrap{flex:1;overflow-y:auto;scroll-behavior:smooth}
.chat-inner{max-width:780px;margin:0 auto;padding:32px 24px 100px}

/* WELCOME STATE */
.welcome{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:calc(100vh - 220px);
text-align:center;animation:fadeUp .6s cubic-bezier(.4,0,.2,1)}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
.welcome h1{font-size:clamp(26px,4vw,36px);font-weight:700;letter-spacing:-.5px;margin-bottom:12px;
background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.welcome p{font-size:15px;font-weight:300;color:var(--text2);max-width:480px;line-height:1.6;margin-bottom:40px}

.sug-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;width:100%;max-width:640px}
@media(max-width:680px){.sug-grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:440px){.sug-grid{grid-template-columns:1fr}}

.sug-card{padding:20px 18px;background:rgba(13,18,32,.5);border:1px solid var(--border);border-radius:16px;
cursor:pointer;text-align:left;transition:all .3s cubic-bezier(.4,0,.2,1);position:relative;overflow:hidden}
.sug-card::before{content:'';position:absolute;inset:0;background:var(--grad);opacity:0;transition:opacity .3s;border-radius:16px}
.sug-card:hover{transform:translateY(-4px);border-color:rgba(16,185,129,.3);
box-shadow:0 8px 30px rgba(16,185,129,.08)}
.sug-card:hover::before{opacity:.05}
.sug-card:active{transform:translateY(-2px)}
.sug-emoji{font-size:24px;margin-bottom:12px;display:block}
.sug-title{font-size:14px;font-weight:600;margin-bottom:4px;color:var(--text);position:relative}
.sug-desc{font-size:12px;font-weight:300;color:var(--text2);line-height:1.5;position:relative}

/* MESSAGES */
.msg{display:flex;margin-bottom:20px;animation:msgIn .4s cubic-bezier(.4,0,.2,1)}
@keyframes msgIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.msg.user{justify-content:flex-end}
.msg.bot{justify-content:flex-start}

.msg .bubble{max-width:85%;padding:14px 20px;font-size:14.5px;line-height:1.7;position:relative}
.msg.user .bubble{background:var(--grad);border-radius:18px 18px 4px 18px;color:#fff;font-weight:400;
box-shadow:0 4px 20px rgba(16,185,129,.15)}
.msg.bot .bubble{background:var(--surface);border-radius:18px 18px 18px 4px;border-left:3px solid var(--accent);
box-shadow:0 2px 12px rgba(0,0,0,.2);padding-right:40px}
.msg .time{font-size:10px;color:var(--text3);margin-top:6px;font-weight:300}
.msg.user .time{text-align:right}

.msg.bot .copy-btn{position:absolute;top:10px;right:10px;width:28px;height:28px;border-radius:8px;border:none;
background:rgba(255,255,255,.05);color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;
opacity:0;transition:all .2s;font-size:12px}
.msg.bot:hover .copy-btn{opacity:1}
.msg.bot .copy-btn:hover{background:rgba(16,185,129,.15);color:var(--accent)}
.msg.bot .copy-btn svg{width:14px;height:14px;fill:currentColor}

/* STREAMING CURSOR */
.cursor{display:inline-block;width:2px;height:16px;background:var(--accent);margin-left:3px;vertical-align:text-bottom;
animation:blink 1s step-end infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}

/* TYPING INDICATOR */
.typing{display:flex;align-items:center;gap:5px;padding:4px 0}
.typing span{width:7px;height:7px;border-radius:50%;background:var(--text2);animation:typePulse 1.4s ease-in-out infinite}
.typing span:nth-child(2){animation-delay:.2s}
.typing span:nth-child(3){animation-delay:.4s}
@keyframes typePulse{0%,60%,100%{opacity:.3;transform:scale(.8)}30%{opacity:1;transform:scale(1)}}

/* MD STYLES */
.msg.bot .bubble h1,.msg.bot .bubble h2,.msg.bot .bubble h3{color:var(--accent);font-weight:600;margin:16px 0 8px;line-height:1.3}
.msg.bot .bubble h1{font-size:18px}.msg.bot .bubble h2{font-size:16px}.msg.bot .bubble h3{font-size:15px}
.msg.bot .bubble strong{color:#f1f5f9;font-weight:600}
.msg.bot .bubble em{font-style:italic;color:var(--text)}
.msg.bot .bubble ul{list-style:none;padding-left:0;margin:8px 0}
.msg.bot .bubble li{padding:3px 0 3px 18px;position:relative;font-size:14px}
.msg.bot .bubble li::before{content:'';position:absolute;left:2px;top:11px;width:6px;height:6px;
border-radius:50%;background:var(--accent)}
.msg.bot .bubble blockquote{border-left:3px solid var(--accent);padding:8px 14px;margin:10px 0;
background:rgba(16,185,129,.05);border-radius:0 8px 8px 0;font-style:italic;color:var(--text2)}
.msg.bot .bubble code{background:rgba(16,185,129,.1);color:var(--accent);padding:2px 8px;border-radius:6px;font-size:13px;font-family:'SF Mono','Fira Code',monospace}
.msg.bot .bubble pre{background:rgba(6,8,15,.6);border:1px solid var(--border);border-radius:12px;padding:16px;margin:12px 0;overflow-x:auto}
.msg.bot .bubble pre code{background:none;color:var(--text);padding:0}
.msg.bot .bubble table{width:100%;border-collapse:separate;border-spacing:0;margin:12px 0;border-radius:12px;overflow:hidden;
border:1px solid var(--border)}
.msg.bot .bubble thead tr{background:var(--grad)}
.msg.bot .bubble th{padding:10px 14px;font-size:13px;font-weight:600;text-align:left;color:#fff}
.msg.bot .bubble td{padding:10px 14px;font-size:13px;border-top:1px solid var(--border)}
.msg.bot .bubble tbody tr:nth-child(even){background:rgba(20,30,51,.5)}
.msg.bot .bubble tbody tr:hover{background:rgba(16,185,129,.05)}
.msg.bot .bubble .citation{display:inline-block;background:rgba(16,185,129,.12);color:var(--accent);
padding:2px 10px;border-radius:20px;font-size:11px;font-weight:500;margin:2px 2px;white-space:nowrap}
.msg.bot .bubble p{margin:0 0 8px}
.msg.bot .bubble p:last-child{margin:0}

/* INPUT AREA */
.input-area{position:fixed;bottom:0;left:0;right:0;padding:16px 24px 24px;
background:linear-gradient(to top,var(--bg) 60%,transparent);z-index:10}
.input-inner{max-width:780px;margin:0 auto;display:flex;align-items:flex-end;gap:12px;
background:rgba(13,18,32,.8);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
border:1px solid var(--border);border-radius:16px;padding:6px 6px 6px 20px;
transition:border .3s,box-shadow .3s}
.input-inner:focus-within{border-color:rgba(16,185,129,.4);box-shadow:0 0 0 3px rgba(16,185,129,.08)}
.input-inner textarea{flex:1;border:none;background:transparent;color:var(--text);font-family:var(--font);
font-size:15px;font-weight:400;resize:none;outline:none;padding:10px 0;max-height:96px;line-height:1.5}
.input-inner textarea::placeholder{color:var(--text3);font-weight:300}
.send-btn{width:40px;height:40px;border-radius:12px;border:none;background:var(--grad);color:#fff;
cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .25s;flex-shrink:0}
.send-btn:hover{transform:scale(1.05);box-shadow:0 4px 16px rgba(16,185,129,.3)}
.send-btn:active{transform:scale(.97)}
.send-btn:disabled{opacity:.3;cursor:default;transform:none;box-shadow:none}
.send-btn svg{width:18px;height:18px;fill:#fff}

/* TRANSITIONS */
.fade-enter{animation:fadeUp .4s cubic-bezier(.4,0,.2,1)}

/* MOBILE */
@media(max-width:640px){
.nav{padding:0 16px}
.nav-brand{font-size:13px}
.chat-inner{padding:20px 16px 100px}
.input-area{padding:12px 16px 16px}
.msg .bubble{max-width:92%}
.login-card{padding:36px 28px}
}
</style>
</head>
<body>
<div class="noise"></div>
<div class="dotgrid"></div>
<div class="orb orb1"></div>
<div class="orb orb2"></div>
<div class="orb orb3"></div>

<!-- LOGIN -->
<div id="login">
<div class="login-card">
<div class="login-icon">
<svg viewBox="0 0 24 24"><path d="M12 2L3 7v2h18V7L12 2zM5 11v6l-2 2v1h18v-1l-2-2v-6h-3v6h-2v-6h-2v6H10v-6H7v6H5v-6z"/></svg>
</div>
<div class="login-title">CMHC Policy Assistant</div>
<div class="login-tagline">AI powered policy intelligence for mortgage professionals</div>
<div class="input-wrap">
<input type="password" id="pw" placeholder=" " autocomplete="off">
<label>Access code</label>
</div>
<button class="login-btn" id="login-btn" onclick="doLogin()">Access Dashboard</button>
<div class="login-error" id="login-err"></div>
<div class="login-badge">Powered by AI</div>
</div>
</div>

<!-- APP -->
<div id="app">
<div class="nav">
<div class="nav-left">
<div class="nav-logo">
<svg viewBox="0 0 24 24"><path d="M12 2L3 7v2h18V7L12 2zM5 11v6l-2 2v1h18v-1l-2-2v-6h-3v6h-2v-6h-2v6H10v-6H7v6H5v-6z"/></svg>
</div>
<span class="nav-brand">CMHC Policy Assistant</span>
</div>
<div class="nav-right">
<button class="nav-btn" onclick="newChat()">
<svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
New Chat
</button>
<div class="avatar">MP</div>
</div>
</div>
<div class="chat-wrap" id="chat-wrap">
<div class="chat-inner" id="chat"></div>
</div>
<div class="input-area">
<div class="input-inner">
<textarea id="input" rows="1" placeholder="Ask about CMHC policies..." onkeydown="handleKey(event)"></textarea>
<button class="send-btn" id="send-btn" onclick="send()">
<svg viewBox="0 0 24 24"><path d="M4 12l1.41 1.41L11 7.83V20h2V7.83l5.59 5.58L20 12l-8-8-8 8z"/></svg>
</button>
</div>
</div>
</div>

<script>
const API_BASE='https://hardwood-input-patterns-guitar.trycloudflare.com';
let messages=[];
let streaming=false;
let token=sessionStorage.getItem('cmhc_token')||'';

// Restore
const saved=localStorage.getItem('cmhc_history');
if(saved)try{messages=JSON.parse(saved)}catch{}
if(token){showApp();renderAll()}

document.getElementById('pw').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin()});

async function doLogin(){
const pw=document.getElementById('pw').value.trim();
if(!pw)return;
const btn=document.getElementById('login-btn');
btn.textContent='Verifying...';btn.disabled=true;
try{
const r=await fetch(API_BASE+'/api/auth',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({password:pw})});
const d=await r.json();
if(d.ok||d.token){
token=d.token||pw;sessionStorage.setItem('cmhc_token',token);
document.getElementById('login').classList.add('hidden');
setTimeout(()=>{showApp();renderAll()},400);
}else{
document.getElementById('login-err').textContent='Invalid access code. Please try again.';
btn.textContent='Access Dashboard';btn.disabled=false;
}
}catch(e){
document.getElementById('login-err').textContent='Connection error. Please try again.';
btn.textContent='Access Dashboard';btn.disabled=false;
}}

function showApp(){
document.getElementById('login').classList.add('hidden');
document.getElementById('app').classList.add('active');
}

function saveHistory(){localStorage.setItem('cmhc_history',JSON.stringify(messages))}

function newChat(){messages=[];localStorage.removeItem('cmhc_history');renderAll()}

function getTime(){const d=new Date();return d.toLocaleTimeString([],{hour:'numeric',minute:'2-digit'})}

const SUGGESTIONS=[
{icon:'‚úÖ',title:'Eligibility Requirements',desc:'Property types, unit minimums, borrower criteria',q:'What are the eligibility requirements for CMHC multi-unit mortgage loan insurance?'},
{icon:'üí∞',title:'Premium Rates',desc:'Current insurance premium schedules and fees',q:'What are the current CMHC multi-unit premium rates?'},
{icon:'üìä',title:'LTV Ratios',desc:'Maximum loan to value by property type',q:'What are the maximum LTV ratios for CMHC insured multi-unit properties?'},
{icon:'üèóÔ∏è',title:'ACLP Program',desc:'Apartment Construction Loan Program details',q:'Can you give me an overview of the CMHC Apartment Construction Loan Program (ACLP)?'},
{icon:'üåø',title:'MLI Select',desc:'Energy efficiency incentives and discounts',q:'How does the MLI Select program work and what are the premium discounts?'},
{icon:'üî®',title:'Construction Financing',desc:'Progress advance and completion requirements',q:'What are CMHC requirements for construction financing and progress advances?'}
];

function renderAll(){
const chat=document.getElementById('chat');
if(messages.length===0){
chat.innerHTML=`<div class="welcome">
<h1>What can I help you with?</h1>
<p>Ask me anything about CMHC multi-unit mortgage insurance, MLI Select, or ACLP</p>
<div class="sug-grid">${SUGGESTIONS.map(s=>`<div class="sug-card" onclick="sendQ('${s.q.replace(/'/g,"\\'")}')">
<span class="sug-emoji">${s.icon}</span>
<div class="sug-title">${s.title}</div>
<div class="sug-desc">${s.desc}</div>
</div>`).join('')}</div></div>`;
return;
}
chat.innerHTML=messages.map((m,i)=>{
if(m.role==='user')return`<div class="msg user"><div><div class="bubble">${esc(m.content)}</div><div class="time">${m.time||''}</div></div></div>`;
return`<div class="msg bot"><div><div class="bubble">${renderMd(m.content)}<button class="copy-btn" onclick="copyMsg(${i})" title="Copy"><svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button></div><div class="time">${m.time||''}</div></div></div>`;
}).join('');
scrollDown();
}

function sendQ(q){document.getElementById('input').value=q;send()}

function handleKey(e){
if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send()}
}

async function send(){
if(streaming)return;
const inp=document.getElementById('input');
const text=inp.value.trim();
if(!text)return;
inp.value='';inp.style.height='auto';
messages.push({role:'user',content:text,time:getTime()});
saveHistory();renderAll();

streaming=true;
document.getElementById('send-btn').disabled=true;

const chat=document.getElementById('chat');
const botDiv=document.createElement('div');botDiv.className='msg bot';
botDiv.innerHTML='<div><div class="bubble"><div class="typing"><span></span><span></span><span></span></div></div></div>';
chat.appendChild(botDiv);scrollDown();

let botText='';
try{
const r=await fetch(API_BASE+'/api/chat',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},
body:JSON.stringify({message:text,history:messages.slice(-7,-1)})});
if(r.status===401){sessionStorage.removeItem('cmhc_token');location.reload();return}
const reader=r.body.getReader();const dec=new TextDecoder();let buf='';
while(true){
const{done,value}=await reader.read();
if(done)break;
buf+=dec.decode(value,{stream:true});
const lines=buf.split('\n');buf=lines.pop();
for(const line of lines){
if(line.startsWith('data: ')&&line.slice(6).trim()!=='[DONE]'){
try{const d=JSON.parse(line.slice(6));if(d.text)botText+=d.text;if(d.error)botText+=d.error}catch{}
}}
botDiv.innerHTML=`<div><div class="bubble">${renderMd(botText)}<span class="cursor"></span><button class="copy-btn" onclick="copyMsg(${messages.length})" title="Copy"><svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button></div></div>`;
scrollDown();
}}catch(e){botText=botText||'Connection error. Please try again.'}

messages.push({role:'assistant',content:botText,time:getTime()});
saveHistory();streaming=false;
document.getElementById('send-btn').disabled=false;
renderAll();
}

function scrollDown(){const w=document.getElementById('chat-wrap');w.scrollTop=w.scrollHeight}

function copyMsg(i){
const t=messages[i]?.content||'';
navigator.clipboard.writeText(t).then(()=>{
const btns=document.querySelectorAll('.msg.bot');
if(btns[Math.floor(i/2)]){const b=btns[Math.floor(i/2)].querySelector('.copy-btn');
if(b){b.innerHTML='‚úì';setTimeout(()=>{b.innerHTML='<svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>';},1500)}}
})}

function esc(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

function renderMd(s){
if(!s)return'';
s=esc(s);
s=s.replace(/\[(Source|Document|File|Ref)[:\s]+([^\]]+)\]/gi,'<span class="citation">$1: $2</span>');
s=s.replace(/^### (.+)$/gm,'<h3>$1</h3>');
s=s.replace(/^## (.+)$/gm,'<h2>$1</h2>');
s=s.replace(/^# (.+)$/gm,'<h1>$1</h1>');
s=s.replace(/\*\*\*(.+?)\*\*\*/g,'<strong><em>$1</em></strong>');
s=s.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
s=s.replace(/\*(.+?)\*/g,'<em>$1</em>');
s=s.replace(/```[\w]*\n([\s\S]*?)```/g,'<pre><code>$1</code></pre>');
s=s.replace(/`([^`]+)`/g,'<code>$1</code>');
s=s.replace(/^(\|.+\|)\n\|[\s\-:|]+\|\n((?:\|.+\|\n?)*)/gm,(m,hdr,rows)=>{
const ths=hdr.split('|').filter(c=>c.trim()).map(c=>`<th>${c.trim()}</th>`).join('');
const trs=rows.trim().split('\n').map(r=>{
const tds=r.split('|').filter(c=>c.trim()).map(c=>`<td>${c.trim()}</td>`).join('');
return`<tr>${tds}</tr>`;}).join('');
return`<table><thead><tr>${ths}</tr></thead><tbody>${trs}</tbody></table>`;});
s=s.replace(/^&gt; (.+)$/gm,'<blockquote>$1</blockquote>');
s=s.replace(/^[\-\*] (.+)$/gm,'<li>$1</li>');
s=s.replace(/^(\d+)\. (.+)$/gm,'<li>$2</li>');
s=s.replace(/((?:<li>.+<\/li>\n?)+)/g,'<ul>$1</ul>');
s=s.replace(/\n\n+/g,'</p><p>');
s=s.replace(/\n/g,'<br>');
s='<p>'+s+'</p>';
s=s.replace(/<p><\/p>/g,'');
return s;
}

document.getElementById('input').addEventListener('input',function(){this.style.height='auto';this.style.height=Math.min(this.scrollHeight,96)+'px'});
</script>
</body>
</html>
