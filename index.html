<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CMHC Multi-Unit Policy Assistant</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --font:'Inter',system-ui,sans-serif;
  --sidebar-w:300px;
  --radius:12px;
  --transition:all .2s cubic-bezier(.4,0,.2,1);
}
[data-theme="dark"]{
  --bg:#0b0f1a;--bg-secondary:#111827;--surface:#1a2233;--surface-hover:#1e2a3e;
  --surface-active:#243349;--border:#1e2d42;--border-light:#15202f;
  --text:#e2e8f0;--text-secondary:#8892a4;--text-muted:#5a6577;
  --primary:#14b8a6;--primary-dim:rgba(20,184,166,.12);--primary-glow:rgba(20,184,166,.25);
  --accent:#06d6a0;--accent-dim:rgba(6,214,160,.1);
  --user-msg:#14b8a6;--user-msg-text:#fff;
  --bot-msg:#151d2e;--bot-border:#1e2d42;
  --header-bg:rgba(17,24,39,.85);--header-border:#1e2d42;
  --input-bg:#111827;--input-border:#1e2d42;--input-focus:#14b8a6;
  --login-bg:#070a12;
  --danger:#ef4444;--warning:#f59e0b;
  --shadow:0 4px 24px rgba(0,0,0,.4);
  --glow:0 0 20px rgba(20,184,166,.15);
}
[data-theme="light"]{
  --bg:#f1f5f9;--bg-secondary:#fff;--surface:#fff;--surface-hover:#f8fafc;
  --surface-active:#f1f5f9;--border:#e2e8f0;--border-light:#f1f5f9;
  --text:#0f172a;--text-secondary:#475569;--text-muted:#94a3b8;
  --primary:#0d9488;--primary-dim:rgba(13,148,136,.08);--primary-glow:rgba(13,148,136,.15);
  --accent:#06d6a0;--accent-dim:rgba(6,214,160,.06);
  --user-msg:#0d9488;--user-msg-text:#fff;
  --bot-msg:#fff;--bot-border:#e2e8f0;
  --header-bg:rgba(255,255,255,.9);--header-border:#e2e8f0;
  --input-bg:#fff;--input-border:#e2e8f0;--input-focus:#0d9488;
  --login-bg:#f1f5f9;
  --danger:#ef4444;--warning:#f59e0b;
  --shadow:0 4px 24px rgba(0,0,0,.08);
  --glow:0 0 20px rgba(13,148,136,.08);
}
html,body{height:100%;overflow:hidden}
body{font-family:var(--font);background:var(--bg);color:var(--text);display:flex;flex-direction:column;-webkit-font-smoothing:antialiased}

/* ========== SCROLLBAR ========== */
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--text-muted)}

/* ========== LOGIN ========== */
.login-overlay{position:fixed;inset:0;z-index:1000;display:flex;align-items:center;justify-content:center;background:var(--login-bg);overflow:hidden}
.login-bg{position:absolute;inset:0;overflow:hidden}
.login-bg .orb{position:absolute;border-radius:50%;filter:blur(80px);opacity:.4;animation:orbFloat 20s ease-in-out infinite}
.login-bg .orb:nth-child(1){width:400px;height:400px;background:var(--primary);top:-10%;left:-5%;animation-delay:0s}
.login-bg .orb:nth-child(2){width:350px;height:350px;background:#6366f1;bottom:-10%;right:-5%;animation-delay:-7s}
.login-bg .orb:nth-child(3){width:250px;height:250px;background:var(--accent);top:50%;left:50%;animation-delay:-14s}
@keyframes orbFloat{0%,100%{transform:translate(0,0) scale(1)}25%{transform:translate(30px,-40px) scale(1.1)}50%{transform:translate(-20px,30px) scale(.95)}75%{transform:translate(40px,20px) scale(1.05)}}
.login-grid{position:absolute;inset:0;background-image:linear-gradient(var(--border) 1px,transparent 1px),linear-gradient(90deg,var(--border) 1px,transparent 1px);background-size:60px 60px;opacity:.15}
.login-card{position:relative;z-index:1;width:90%;max-width:420px;background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:48px 40px;backdrop-filter:blur(20px);box-shadow:var(--shadow)}
.login-logo{width:64px;height:64px;margin:0 auto 24px;background:linear-gradient(135deg,var(--primary),var(--accent));border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:28px;box-shadow:var(--glow)}
.login-card h1{font-size:24px;font-weight:800;text-align:center;margin-bottom:4px;letter-spacing:-.5px}
.login-card .tagline{text-align:center;color:var(--text-secondary);font-size:14px;margin-bottom:32px}
.login-features{display:flex;flex-direction:column;gap:12px;margin-bottom:28px}
.login-feature{display:flex;align-items:center;gap:12px;font-size:13px;color:var(--text-secondary)}
.login-feature .lf-icon{width:32px;height:32px;border-radius:8px;background:var(--primary-dim);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.login-input{width:100%;padding:14px 18px;background:var(--input-bg);border:1.5px solid var(--input-border);border-radius:var(--radius);color:var(--text);font-family:var(--font);font-size:15px;text-align:center;letter-spacing:3px;outline:none;transition:var(--transition);margin-bottom:14px}
.login-input:focus{border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-glow)}
.login-input::placeholder{letter-spacing:normal;color:var(--text-muted)}
.login-btn{width:100%;padding:14px;border:none;border-radius:var(--radius);background:linear-gradient(135deg,var(--primary),var(--accent));color:#fff;font-family:var(--font);font-size:15px;font-weight:600;cursor:pointer;transition:var(--transition);position:relative;overflow:hidden}
.login-btn:hover{transform:translateY(-1px);box-shadow:var(--glow)}
.login-btn:active{transform:translateY(0)}
.login-error{color:var(--danger);font-size:13px;text-align:center;margin-top:12px;display:none}

/* ========== HEADER ========== */
.header{height:56px;display:flex;align-items:center;gap:12px;padding:0 20px;background:var(--header-bg);border-bottom:1px solid var(--header-border);backdrop-filter:blur(12px);z-index:20;flex-shrink:0}
.hamburger{display:none;background:none;border:none;color:var(--text);font-size:22px;cursor:pointer;padding:6px;border-radius:8px;transition:var(--transition)}
.hamburger:hover{background:var(--surface-hover)}
.header-logo{width:34px;height:34px;background:linear-gradient(135deg,var(--primary),var(--accent));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.header-title{font-size:15px;font-weight:700;letter-spacing:-.3px;white-space:nowrap}
.header-badge{font-size:10px;font-weight:600;padding:3px 8px;border-radius:6px;background:var(--primary-dim);color:var(--primary);text-transform:uppercase;letter-spacing:.5px}
.header-spacer{flex:1}
.header-btn{background:none;border:1px solid var(--border);color:var(--text-secondary);font-family:var(--font);font-size:13px;font-weight:500;padding:7px 14px;border-radius:8px;cursor:pointer;transition:var(--transition);display:flex;align-items:center;gap:6px}
.header-btn:hover{background:var(--surface-hover);color:var(--text);border-color:var(--primary)}
.theme-toggle{background:none;border:none;color:var(--text-secondary);font-size:18px;cursor:pointer;padding:6px;border-radius:8px;transition:var(--transition);display:flex;align-items:center}
.theme-toggle:hover{color:var(--text);background:var(--surface-hover)}

/* ========== LAYOUT ========== */
.main{display:flex;flex:1;overflow:hidden}
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:29;backdrop-filter:blur(2px)}
.sidebar{width:var(--sidebar-w);background:var(--bg-secondary);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;overflow-y:auto;z-index:30}
.sidebar-section{padding:16px 16px 4px}
.sidebar-label{font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.8px;padding:0 4px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;user-select:none}
.sidebar-label::after{content:'‚ñæ';font-size:10px;transition:transform .2s}
.sidebar-label.collapsed::after{transform:rotate(-90deg)}
.sidebar-group{display:flex;flex-direction:column;gap:2px;overflow:hidden;transition:max-height .3s ease,opacity .2s}
.sidebar-group.collapsed{max-height:0!important;opacity:0}
.topic-btn{display:flex;align-items:center;gap:10px;padding:10px 12px;border:none;background:transparent;text-align:left;font-family:var(--font);font-size:13px;font-weight:500;color:var(--text-secondary);cursor:pointer;transition:var(--transition);width:100%;border-radius:8px;line-height:1.4}
.topic-btn:hover{background:var(--surface-hover);color:var(--text)}
.topic-btn:active{background:var(--surface-active)}
.topic-btn .t-icon{width:28px;height:28px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;background:var(--primary-dim)}
.topic-btn.cat-aclp .t-icon{background:rgba(99,102,241,.12)}

/* ========== CHAT AREA ========== */
.chat-area{flex:1;display:flex;flex-direction:column;min-width:0;position:relative}
.messages{flex:1;overflow-y:auto;padding:20px 24px;display:flex;flex-direction:column;gap:16px}
.messages:empty::before{content:''}

/* Welcome screen */
.welcome{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;padding:40px 20px;animation:fadeUp .5s ease}
.welcome-icon{font-size:48px;margin-bottom:20px;opacity:.8}
.welcome h2{font-size:22px;font-weight:700;margin-bottom:8px;letter-spacing:-.3px}
.welcome p{font-size:14px;color:var(--text-secondary);max-width:420px;text-align:center;line-height:1.6;margin-bottom:32px}
.starter-cards{display:grid;grid-template-columns:1fr 1fr;gap:10px;max-width:520px;width:100%}
.starter-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;cursor:pointer;transition:var(--transition);text-align:left;font-family:var(--font)}
.starter-card:hover{border-color:var(--primary);background:var(--surface-hover);transform:translateY(-2px);box-shadow:var(--glow)}
.starter-card .sc-icon{font-size:18px;margin-bottom:8px}
.starter-card .sc-title{font-size:13px;font-weight:600;color:var(--text);margin-bottom:3px}
.starter-card .sc-desc{font-size:11px;color:var(--text-muted);line-height:1.4}

/* Messages */
.msg{max-width:780px;line-height:1.7;animation:fadeUp .3s ease}
.msg.user{align-self:flex-end;background:var(--user-msg);color:var(--user-msg-text);padding:12px 18px;border-radius:16px 16px 4px 16px;font-size:14px;max-width:600px}
.msg-wrapper{display:flex;flex-direction:column;gap:6px;align-self:flex-start;width:100%;max-width:780px}
.msg-header{display:flex;align-items:center;gap:8px}
.msg-avatar{width:24px;height:24px;border-radius:7px;background:linear-gradient(135deg,var(--primary),var(--accent));display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0}
.msg-name{font-size:12px;font-weight:600;color:var(--text-secondary)}
.msg-time{font-size:11px;color:var(--text-muted)}
.msg.bot{background:var(--bot-msg);border:1px solid var(--bot-border);padding:16px 20px;border-radius:4px 16px 16px 16px;font-size:14px}
.msg.bot h1,.msg.bot h2,.msg.bot h3{margin:14px 0 6px;color:var(--primary);font-weight:700}
.msg.bot h1{font-size:17px}.msg.bot h2{font-size:15px}.msg.bot h3{font-size:14px}
.msg.bot p{margin:5px 0}.msg.bot ul,.msg.bot ol{margin:5px 0 5px 18px}
.msg.bot li{margin:3px 0;font-size:14px}
.msg.bot strong{color:var(--primary)}
.msg.bot table{border-collapse:collapse;margin:12px 0;width:100%;font-size:12px;border-radius:8px;overflow:hidden}
.msg.bot th{background:var(--primary);color:#fff;padding:8px 12px;text-align:left;font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.3px}
.msg.bot td{padding:8px 12px;border-bottom:1px solid var(--border)}
.msg.bot tr:nth-child(even){background:var(--surface-hover)}
.msg.bot code{background:var(--surface-active);padding:2px 6px;border-radius:4px;font-size:12px;font-family:'SF Mono',Monaco,Consolas,monospace}
.msg.bot blockquote{border-left:3px solid var(--primary);padding:8px 14px;margin:8px 0;background:var(--primary-dim);border-radius:0 8px 8px 0;font-size:13px}
.msg-actions{display:flex;gap:4px;margin-top:4px;opacity:0;transition:opacity .2s}
.msg-wrapper:hover .msg-actions{opacity:1}
.msg-action-btn{background:none;border:1px solid var(--border);color:var(--text-muted);font-size:11px;padding:4px 10px;border-radius:6px;cursor:pointer;font-family:var(--font);transition:var(--transition);display:flex;align-items:center;gap:4px}
.msg-action-btn:hover{background:var(--surface-hover);color:var(--text);border-color:var(--primary)}
.msg-action-btn.copied{color:var(--primary);border-color:var(--primary)}

/* Thinking indicator */
.thinking{display:flex;align-items:center;gap:10px;padding:16px 20px;align-self:flex-start;animation:fadeUp .3s}
.thinking-dots{display:flex;gap:4px}
.thinking-dots span{width:6px;height:6px;background:var(--primary);border-radius:50%;animation:pulse 1.4s ease-in-out infinite}
.thinking-dots span:nth-child(2){animation-delay:.2s}
.thinking-dots span:nth-child(3){animation-delay:.4s}
.thinking-text{font-size:12px;color:var(--text-muted);font-weight:500}
@keyframes pulse{0%,80%,100%{opacity:.3;transform:scale(.8)}40%{opacity:1;transform:scale(1)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}

/* ========== INPUT ========== */
.input-area{padding:12px 20px 8px;background:var(--bg);border-top:1px solid var(--border)}
.input-wrap{display:flex;gap:10px;max-width:800px;margin:0 auto;background:var(--input-bg);border:1.5px solid var(--input-border);border-radius:14px;padding:4px 4px 4px 16px;transition:var(--transition);align-items:flex-end}
.input-wrap:focus-within{border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-glow)}
.input-wrap textarea{flex:1;padding:10px 0;background:transparent;border:none;color:var(--text);font-family:var(--font);font-size:14px;resize:none;outline:none;min-height:20px;max-height:120px;line-height:1.5}
.input-wrap textarea::placeholder{color:var(--text-muted)}
.send-btn{width:40px;height:40px;border-radius:10px;border:none;background:var(--primary);color:#fff;font-size:16px;cursor:pointer;transition:var(--transition);flex-shrink:0;display:flex;align-items:center;justify-content:center}
.send-btn:hover{opacity:.85;transform:scale(1.05)}
.send-btn:disabled{opacity:.3;cursor:not-allowed;transform:none}
.input-hint{text-align:center;padding:6px;font-size:11px;color:var(--text-muted)}
.input-hint kbd{background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:1px 5px;font-family:var(--font);font-size:10px}

/* ========== LOADING SCREEN ========== */
.app-loader{position:fixed;inset:0;background:var(--bg);z-index:2000;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px;transition:opacity .4s}
.app-loader.hidden{opacity:0;pointer-events:none}
.loader-spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* ========== RESPONSIVE ========== */
@media(max-width:768px){
  .sidebar{position:fixed;left:0;top:0;bottom:0;width:280px;z-index:30;transform:translateX(-100%);transition:transform .3s cubic-bezier(.4,0,.2,1)}
  .sidebar.open{transform:translateX(0)}
  .sidebar-overlay.open{display:block}
  .hamburger{display:flex}
  .header-title{font-size:14px}
  .header-badge{display:none}
  .messages{padding:16px}
  .starter-cards{grid-template-columns:1fr}
  .input-area{padding:8px 12px 6px}
  .msg.user{max-width:85%}
}
@media(max-width:480px){
  .login-card{padding:36px 24px}
  .header-btn span{display:none}
}
</style>
</head>
<body>

<!-- App loader -->
<div class="app-loader" id="appLoader">
  <div class="loader-spinner"></div>
</div>

<!-- Login -->
<div class="login-overlay" id="loginOverlay">
  <div class="login-bg">
    <div class="orb"></div><div class="orb"></div><div class="orb"></div>
    <div class="login-grid"></div>
  </div>
  <div class="login-card">
    <div class="login-logo">üè¢</div>
    <h1>CMHC Policy Assistant</h1>
    <p class="tagline">Your AI powered CMHC multi unit policy expert</p>
    <div class="login-features">
      <div class="login-feature"><div class="lf-icon">‚ö°</div><span>Instant answers on eligibility, premiums, and LTV ratios</span></div>
      <div class="login-feature"><div class="lf-icon">üìã</div><span>Full documentation checklists and processing guidance</span></div>
      <div class="login-feature"><div class="lf-icon">üèóÔ∏è</div><span>MLI Select, ACLP, and construction financing details</span></div>
    </div>
    <input type="password" class="login-input" id="loginPassword" placeholder="Enter access code" onkeydown="if(event.key==='Enter')doLogin()" autocomplete="off">
    <button class="login-btn" onclick="doLogin()">Access Dashboard</button>
    <div class="login-error" id="loginError">Invalid access code. Please try again.</div>
  </div>
</div>

<!-- Header -->
<div class="header">
  <button class="hamburger" onclick="toggleSidebar()" aria-label="Menu">‚ò∞</button>
  <div class="header-logo">üè¢</div>
  <span class="header-title">CMHC Policy Assistant</span>
  <span class="header-badge">Beta</span>
  <div class="header-spacer"></div>
  <button class="header-btn" onclick="newChat()" title="New Chat">‚ú¶ <span>New Chat</span></button>
  <button class="theme-toggle" onclick="toggleTheme()" id="themeBtn" title="Toggle theme">üåô</button>
</div>

<!-- Main -->
<div class="main">
  <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-label" onclick="toggleSection(this)">Multi Unit Insurance</div>
      <div class="sidebar-group">
        <button class="topic-btn" onclick="askTopic(this)" data-q="What are the eligibility requirements for CMHC multi-unit mortgage loan insurance? What property types qualify, what are the minimum unit requirements, and what are the borrower requirements?"><div class="t-icon">‚úì</div><span>Eligibility Requirements</span></button>
        <button class="topic-btn" onclick="askTopic(this)" data-q="What are the current CMHC multi-unit insurance premium rates? Please show the full premium rate tables for both Standard Rental Housing and All Other Shelter Models, including construction financing rates and surcharges."><div class="t-icon">üí∞</div><span>Premium Rates</span></button>
        <button class="topic-btn" onclick="askTopic(this)" data-q="What are the maximum loan-to-value (LTV) ratios for CMHC multi-unit mortgage insurance? How do they differ between Market Rental and MLI Select, and between purchase, refinance, and construction?"><div class="t-icon">üìä</div><span>LTV Ratios</span></button>
        <button class="topic-btn" onclick="askTopic(this)" data-q="What documents are required for a CMHC multi-unit mortgage insurance application? Please provide the full documentation checklist including financial, property, project planning, legal, and environmental requirements."><div class="t-icon">üìã</div><span>Documentation Checklist</span></button>
        <button class="topic-btn" onclick="askTopic(this)" data-q="How does CMHC multi-unit insurance differ for rental properties versus condominium projects? What are the key considerations for each type?"><div class="t-icon">üèòÔ∏è</div><span>Rental vs Condo</span></button>
        <button class="topic-btn" onclick="askTopic(this)" data-q="How does CMHC construction financing work for multi-unit properties? What are the premium rates, LTV limits, process, and required documentation for construction loans?"><div class="t-icon">üèóÔ∏è</div><span>Construction Financing</span></button>
        <button class="topic-btn" onclick="askTopic(this)" data-q="What affordable housing incentives does CMHC offer through its multi-unit programs? How does the MLI Select affordability scoring work, and what programs like ACLP complement it?"><div class="t-icon">üè†</div><span>Affordable Housing</span></button>
        <button class="topic-btn" onclick="askTopic(this)" data-q="What are the CMHC rules for refinancing multi-unit properties? What are the maximum LTV ratios, premium rates, eligible purposes, and special rules for affordable housing refinancing?"><div class="t-icon">üîÑ</div><span>Refinancing Rules</span></button>
        <button class="topic-btn" onclick="askTopic(this)" data-q="What are the typical processing timelines for CMHC multi-unit mortgage insurance applications? What factors affect processing time and how can I expedite the process?"><div class="t-icon">‚è±Ô∏è</div><span>Processing Timelines</span></button>
        <button class="topic-btn" onclick="askTopic(this)" data-q="What are CMHC's environmental requirements for multi-unit mortgage insurance? What Phase I and Phase II ESA requirements apply, and what energy efficiency standards are expected?"><div class="t-icon">üåø</div><span>Environmental Requirements</span></button>
        <button class="topic-btn" onclick="askTopic(this)" data-q="What is the CMHC MLI Select program? How does the points-based system work for affordability, energy efficiency, and accessibility? What are the premium discounts and other benefits?"><div class="t-icon">‚≠ê</div><span>MLI Select Program</span></button>
        <button class="topic-btn" onclick="askTopic(this)" data-q="What are the most recent changes to CMHC multi-unit mortgage insurance policies in 2025? What changed with Advice 263 and 264, and how do the new premium structures work?"><div class="t-icon">üì∞</div><span>2025 Policy Changes</span></button>
      </div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-label" onclick="toggleSection(this)">ACLP Program</div>
      <div class="sidebar-group">
        <button class="topic-btn cat-aclp" onclick="askTopic(this)" data-q="What is the CMHC Apartment Construction Loan Program (ACLP)? How does it work, what does it offer, and what types of projects does it fund? Please provide a comprehensive overview."><div class="t-icon">üèóÔ∏è</div><span>ACLP Overview</span></button>
        <button class="topic-btn cat-aclp" onclick="askTopic(this)" data-q="What are the eligibility requirements for the CMHC ACLP program? Who can apply, what project types qualify, and what are the affordability requirements? Include details on student housing and seniors housing eligibility."><div class="t-icon">‚úì</div><span>ACLP Eligibility</span></button>
        <button class="topic-btn cat-aclp" onclick="askTopic(this)" data-q="What are the ACLP loan terms, interest rates, and financial details? What is the maximum loan amount, loan-to-cost ratio, amortization period, and how are interest rates determined?"><div class="t-icon">üí∞</div><span>ACLP Terms & Rates</span></button>
        <button class="topic-btn cat-aclp" onclick="askTopic(this)" data-q="What is the ACLP application process? What are the steps, required documentation, timeline, and tips for a strong application? Include details on the scoring system and Frequent Builder framework."><div class="t-icon">üìã</div><span>ACLP Application Process</span></button>
        <button class="topic-btn cat-aclp" onclick="askTopic(this)" data-q="How does the CMHC ACLP compare to standard Multi-Unit Mortgage Loan Insurance (MU MLI) and MLI Select? When should a developer use each program, and how do they complement each other?"><div class="t-icon">‚öñÔ∏è</div><span>ACLP vs MLI vs MLI Select</span></button>
      </div>
    </div>
  </aside>
  <div class="chat-area">
    <div class="messages" id="messages">
      <div class="welcome" id="welcomeScreen">
        <div class="welcome-icon">üè¢</div>
        <h2>How can I help you today?</h2>
        <p>Ask anything about CMHC multi unit mortgage loan insurance, MLI Select, or the Apartment Construction Loan Program. I have the latest policies and guidelines ready.</p>
        <div class="starter-cards">
          <div class="starter-card" onclick="askStarter('What are the current CMHC multi-unit insurance premium rates? Show me the full rate tables.')">
            <div class="sc-icon">üí∞</div>
            <div class="sc-title">Premium Rate Tables</div>
            <div class="sc-desc">Current rates for all property types and LTV tiers</div>
          </div>
          <div class="starter-card" onclick="askStarter('What are the eligibility requirements for CMHC multi-unit mortgage loan insurance?')">
            <div class="sc-icon">‚úì</div>
            <div class="sc-title">Eligibility Check</div>
            <div class="sc-desc">Property types, unit counts, and borrower requirements</div>
          </div>
          <div class="starter-card" onclick="askStarter('What is MLI Select and how does the points system work for premium discounts?')">
            <div class="sc-icon">‚≠ê</div>
            <div class="sc-title">MLI Select Program</div>
            <div class="sc-desc">Points system, discounts, and qualification criteria</div>
          </div>
          <div class="starter-card" onclick="askStarter('Compare ACLP vs standard multi-unit insurance. When should I use each?')">
            <div class="sc-icon">‚öñÔ∏è</div>
            <div class="sc-title">ACLP vs MLI</div>
            <div class="sc-desc">Program comparison and when to use each option</div>
          </div>
        </div>
      </div>
    </div>
    <div class="input-area">
      <div class="input-wrap">
        <textarea id="input" placeholder="Ask about CMHC multi unit policies..." rows="1" onkeydown="handleKey(event)"></textarea>
        <button class="send-btn" id="sendBtn" onclick="send()">‚û§</button>
      </div>
      <div class="input-hint">This tool provides information based on public CMHC documentation. Always verify with CMHC for official decisions.</div>
    </div>
  </div>
</div>

<script>
const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
  ? '' : 'http://178.156.217.249:3456';
const msgs=document.getElementById('messages'),input=document.getElementById('input'),sendBtn=document.getElementById('sendBtn');
let history=[],streaming=false,authToken=sessionStorage.getItem('cmhc_token')||'';
const STORAGE_KEY='cmhc_chat_history';

// Theme
function setTheme(t){document.documentElement.setAttribute('data-theme',t);localStorage.setItem('cmhc_theme',t);document.getElementById('themeBtn').textContent=t==='dark'?'‚òÄÔ∏è':'üåô'}
function toggleTheme(){setTheme(document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark')}
setTheme(localStorage.getItem('cmhc_theme')||'dark');

// App loader
window.addEventListener('load',()=>{setTimeout(()=>{document.getElementById('appLoader').classList.add('hidden')},400)});

// Auto-login if token exists
if(authToken)document.getElementById('loginOverlay').style.display='none';

// Restore chat history from localStorage
function restoreChat(){
  const saved=localStorage.getItem(STORAGE_KEY);
  if(!saved)return;
  try{
    const items=JSON.parse(saved);
    if(!items.length)return;
    const w=document.getElementById('welcomeScreen');
    if(w)w.remove();
    for(const item of items){
      if(item.role==='user'){
        addMsg('user',escHtml(item.content),false);
        history.push({role:'user',content:item.content});
      }else{
        const wrapper=createBotWrapper();
        const botDiv=wrapper.querySelector('.msg.bot');
        botDiv.innerHTML=md(item.content);
        msgs.appendChild(wrapper);
        history.push({role:'assistant',content:item.content});
      }
    }
    msgs.scrollTop=msgs.scrollHeight;
  }catch(e){}
}
function saveChat(){
  try{localStorage.setItem(STORAGE_KEY,JSON.stringify(history.slice(-20)))}catch(e){}
}
if(authToken)restoreChat();

async function doLogin(){
  const pw=document.getElementById('loginPassword').value;
  try{
    const res=await fetch(API_BASE+'/api/auth',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({password:pw})});
    const data=await res.json();
    if(data.ok){
      authToken=data.token;
      sessionStorage.setItem('cmhc_token',authToken);
      document.getElementById('loginOverlay').style.display='none';
      document.getElementById('loginError').style.display='none';
      restoreChat();
    }else{
      document.getElementById('loginError').style.display='block';
    }
  }catch(e){
    document.getElementById('loginError').textContent='Connection error. Please try again.';
    document.getElementById('loginError').style.display='block';
  }
}

function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('open');
  document.querySelector('.sidebar-overlay').classList.toggle('open');
}
function toggleSection(el){
  el.classList.toggle('collapsed');
  el.nextElementSibling.classList.toggle('collapsed');
}
function newChat(){
  history=[];
  msgs.innerHTML='';
  localStorage.removeItem(STORAGE_KEY);
  // Recreate welcome
  msgs.innerHTML=`<div class="welcome" id="welcomeScreen">
    <div class="welcome-icon">üè¢</div>
    <h2>How can I help you today?</h2>
    <p>Ask anything about CMHC multi unit mortgage loan insurance, MLI Select, or the Apartment Construction Loan Program. I have the latest policies and guidelines ready.</p>
    <div class="starter-cards">
      <div class="starter-card" onclick="askStarter('What are the current CMHC multi-unit insurance premium rates? Show me the full rate tables.')"><div class="sc-icon">üí∞</div><div class="sc-title">Premium Rate Tables</div><div class="sc-desc">Current rates for all property types and LTV tiers</div></div>
      <div class="starter-card" onclick="askStarter('What are the eligibility requirements for CMHC multi-unit mortgage loan insurance?')"><div class="sc-icon">‚úì</div><div class="sc-title">Eligibility Check</div><div class="sc-desc">Property types, unit counts, and borrower requirements</div></div>
      <div class="starter-card" onclick="askStarter('What is MLI Select and how does the points system work for premium discounts?')"><div class="sc-icon">‚≠ê</div><div class="sc-title">MLI Select Program</div><div class="sc-desc">Points system, discounts, and qualification criteria</div></div>
      <div class="starter-card" onclick="askStarter('Compare ACLP vs standard multi-unit insurance. When should I use each?')"><div class="sc-icon">‚öñÔ∏è</div><div class="sc-title">ACLP vs MLI</div><div class="sc-desc">Program comparison and when to use each option</div></div>
    </div>
  </div>`;
}
function askTopic(btn){
  if(window.innerWidth<=768)toggleSidebar();
  input.value=btn.dataset.q;
  send();
}
function askStarter(q){
  input.value=q;
  send();
}
function escHtml(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function getTime(){const d=new Date();return d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}
function addMsg(role,html,scroll=true){
  const d=document.createElement('div');
  d.className='msg '+role;
  d.innerHTML=html;
  const w=document.getElementById('welcomeScreen');
  if(w)w.remove();
  msgs.appendChild(d);
  if(scroll)msgs.scrollTop=msgs.scrollHeight;
  return d;
}
function createBotWrapper(){
  const wrapper=document.createElement('div');
  wrapper.className='msg-wrapper';
  wrapper.innerHTML=`<div class="msg-header"><div class="msg-avatar">üè¢</div><span class="msg-name">CMHC Assistant</span><span class="msg-time">${getTime()}</span></div><div class="msg bot"></div><div class="msg-actions"><button class="msg-action-btn" onclick="copyMsg(this)">üìã Copy</button></div>`;
  return wrapper;
}
function copyMsg(btn){
  const botDiv=btn.closest('.msg-wrapper').querySelector('.msg.bot');
  const text=botDiv.innerText;
  navigator.clipboard.writeText(text).then(()=>{
    btn.classList.add('copied');btn.innerHTML='‚úì Copied';
    setTimeout(()=>{btn.classList.remove('copied');btn.innerHTML='üìã Copy'},2000);
  });
}
function showTyping(){
  const d=document.createElement('div');
  d.className='thinking';d.id='typing';
  d.innerHTML='<div class="thinking-dots"><span></span><span></span><span></span></div><span class="thinking-text">Analyzing policies...</span>';
  msgs.appendChild(d);msgs.scrollTop=msgs.scrollHeight;
}
function hideTyping(){const t=document.getElementById('typing');if(t)t.remove()}

function md(text){
  text=text.replace(/^\|(.+)\|\s*\n\|[-| :]+\|\s*\n((\|.+\|\s*\n?)*)/gm,(m,hdr,body)=>{
    const ths=hdr.split('|').map(c=>`<th>${c.trim()}</th>`).join('');
    const rows=body.trim().split('\n').map(r=>{
      const tds=r.replace(/^\||\|$/g,'').split('|').map(c=>`<td>${c.trim()}</td>`).join('');
      return `<tr>${tds}</tr>`;
    }).join('');
    return `<table><thead><tr>${ths}</tr></thead><tbody>${rows}</tbody></table>`;
  });
  text=text.replace(/^### (.+)$/gm,'<h3>$1</h3>');
  text=text.replace(/^## (.+)$/gm,'<h2>$1</h2>');
  text=text.replace(/^# (.+)$/gm,'<h1>$1</h1>');
  text=text.replace(/^> (.+)$/gm,'<blockquote>$1</blockquote>');
  text=text.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  text=text.replace(/\*(.+?)\*/g,'<em>$1</em>');
  text=text.replace(/`(.+?)`/g,'<code>$1</code>');
  text=text.replace(/^(\s*)[-‚Ä¢] (.+)$/gm,'$1<li>$2</li>');
  text=text.replace(/(<li>.*<\/li>\n?)+/gs,m=>'<ul>'+m+'</ul>');
  text=text.replace(/^\d+\. (.+)$/gm,'<li>$1</li>');
  text=text.replace(/\n{2,}/g,'</p><p>');
  text='<p>'+text+'</p>';
  text=text.replace(/<p>\s*(<[hultbHULTB])/g,'$1');
  text=text.replace(/(<\/[hultbHULTB][^>]*>)\s*<\/p>/g,'$1');
  return text;
}

function handleKey(e){
  if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send()}
}
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){
    if(document.getElementById('sidebar').classList.contains('open'))toggleSidebar();
  }
});

async function send(){
  const text=input.value.trim();
  if(!text||streaming)return;
  streaming=true;sendBtn.disabled=true;
  input.value='';input.style.height='auto';

  addMsg('user',escHtml(text));
  history.push({role:'user',content:text});
  showTyping();

  let fullText='';
  const wrapper=createBotWrapper();
  const botDiv=wrapper.querySelector('.msg.bot');

  try{
    const res=await fetch(API_BASE+'/api/chat',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+authToken},
      body:JSON.stringify({message:text,history:history.slice(-10)})
    });
    hideTyping();
    msgs.appendChild(wrapper);

    const reader=res.body.getReader();
    const dec=new TextDecoder();
    let buf='';
    while(true){
      const{done,value}=await reader.read();
      if(done)break;
      buf+=dec.decode(value,{stream:true});
      const lines=buf.split('\n');
      buf=lines.pop();
      for(const line of lines){
        if(line.startsWith('data: ')){
          const d=line.slice(6);
          if(d==='[DONE]')continue;
          try{
            const j=JSON.parse(d);
            if(j.text){fullText+=j.text;botDiv.innerHTML=md(fullText);msgs.scrollTop=msgs.scrollHeight}
            if(j.error){botDiv.innerHTML='<p>‚ö†Ô∏è '+j.error+'</p>'}
          }catch{}
        }
      }
    }
    history.push({role:'assistant',content:fullText});
    saveChat();
  }catch(e){
    hideTyping();
    addMsg('bot','<p>‚ö†Ô∏è Connection error. Please try again.</p>');
  }
  streaming=false;sendBtn.disabled=false;input.focus();
}

input.addEventListener('input',()=>{input.style.height='auto';input.style.height=Math.min(input.scrollHeight,120)+'px'});
</script>
</body>
</html>