<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CMHC Policy Assistant</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0f1a;--bg2:#0f1525;--surface:#141c2e;--surface2:#1a2540;
  --accent:#10b981;--accent2:#0ea5e9;--accent-dim:rgba(16,185,129,0.12);
  --text:#e8ecf4;--text2:#8899b0;--text3:#4a5568;
  --border:#1a2540;--radius:12px;
  --font:'Inter',system-ui,-apple-system,sans-serif;
}
html,body{height:100%;font-family:var(--font);background:var(--bg);color:var(--text);overflow:hidden}
a{color:var(--accent)}
::selection{background:var(--accent);color:#fff}
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:#2a3a58}

/* LOGIN */
#login-screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:100;
  background:var(--bg)}
#login-screen::before{content:'';position:absolute;inset:0;
  background:radial-gradient(ellipse at 30% 20%,rgba(16,185,129,0.08),transparent 50%),
             radial-gradient(ellipse at 70% 80%,rgba(14,165,233,0.06),transparent 50%);
  animation:bgShift 12s ease-in-out infinite alternate}
@keyframes bgShift{0%{opacity:0.7}50%{opacity:1}100%{opacity:0.7}}
.login-box{position:relative;text-align:center;max-width:380px;width:90%}
.login-logo{width:56px;height:56px;background:linear-gradient(135deg,var(--accent),var(--accent2));
  border-radius:14px;margin:0 auto 24px;display:flex;align-items:center;justify-content:center;font-size:24px;color:#fff}
.login-title{font-size:22px;font-weight:700;letter-spacing:-0.3px;margin-bottom:8px}
.login-tagline{font-size:14px;color:var(--text2);line-height:1.5;margin-bottom:36px}
.login-input{width:100%;padding:14px 18px;background:var(--surface);border:1px solid var(--border);
  border-radius:10px;color:var(--text);font-family:var(--font);font-size:15px;outline:none;transition:border .2s}
.login-input:focus{border-color:var(--accent)}
.login-input::placeholder{color:var(--text3)}
.login-btn{width:100%;margin-top:14px;padding:14px;background:var(--accent);color:#fff;border:none;
  border-radius:10px;font-family:var(--font);font-size:15px;font-weight:600;cursor:pointer;transition:all .2s}
.login-btn:hover{background:#0da572;transform:translateY(-1px)}
.login-btn:active{transform:translateY(0)}
.login-error{color:#f87171;font-size:13px;margin-top:12px;min-height:20px}
.login-hide{display:none!important}

/* APP */
#app{display:none;flex-direction:column;height:100vh}
#app.active{display:flex}

/* HEADER */
.header{display:flex;align-items:center;justify-content:space-between;padding:16px 24px;
  border-bottom:1px solid var(--border);background:var(--bg2);flex-shrink:0}
.header-brand{display:flex;align-items:center;gap:12px}
.header-icon{width:32px;height:32px;background:linear-gradient(135deg,var(--accent),var(--accent2));
  border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px;color:#fff}
.header-name{font-size:16px;font-weight:600;letter-spacing:-0.2px}
.header-btn{padding:8px 16px;background:var(--surface);border:1px solid var(--border);border-radius:8px;
  color:var(--text2);font-family:var(--font);font-size:13px;font-weight:500;cursor:pointer;transition:all .2s}
.header-btn:hover{background:var(--surface2);color:var(--text)}

/* CHAT AREA */
.chat-wrap{flex:1;overflow-y:auto;padding:0}
.chat-inner{max-width:780px;margin:0 auto;padding:24px 20px 120px}

/* WELCOME */
.welcome{text-align:center;padding:60px 0 40px}
.welcome h2{font-size:24px;font-weight:700;letter-spacing:-0.3px;margin-bottom:8px}
.welcome p{color:var(--text2);font-size:14px;margin-bottom:40px}
.suggestions{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;text-align:left}
.sug-card{padding:16px;background:var(--surface);border:1px solid var(--border);border-radius:10px;
  cursor:pointer;transition:all .2s}
.sug-card:hover{background:var(--surface2);border-color:var(--accent);transform:translateY(-2px)}
.sug-icon{font-size:20px;margin-bottom:8px}
.sug-title{font-size:14px;font-weight:600;margin-bottom:4px}
.sug-desc{font-size:12px;color:var(--text2);line-height:1.4}

/* MESSAGES */
.msg{margin-bottom:20px;display:flex;gap:12px}
.msg.user{justify-content:flex-end}
.msg.user .msg-bubble{background:var(--accent);color:#fff;border-radius:16px 16px 4px 16px;max-width:70%}
.msg.bot .msg-bubble{background:var(--surface);border:1px solid var(--border);border-radius:16px 16px 16px 4px;
  max-width:85%;position:relative}
.msg-bubble{padding:14px 18px;font-size:14px;line-height:1.7}
.msg-bubble p{margin-bottom:10px}
.msg-bubble p:last-child{margin-bottom:0}
.msg-bubble strong{color:var(--accent);font-weight:600}
.msg-bubble ul,.msg-bubble ol{margin:8px 0 8px 20px}
.msg-bubble li{margin-bottom:4px}
.msg-bubble code{background:rgba(255,255,255,0.08);padding:2px 6px;border-radius:4px;font-size:13px}
.msg-bubble pre{background:var(--bg);padding:12px;border-radius:8px;overflow-x:auto;margin:10px 0}
.msg-bubble pre code{background:none;padding:0}
.msg-bubble table{width:100%;border-collapse:collapse;margin:12px 0;font-size:13px}
.msg-bubble th{background:rgba(16,185,129,0.1);color:var(--accent);text-align:left;padding:10px 12px;
  border-bottom:2px solid var(--border);font-weight:600}
.msg-bubble td{padding:8px 12px;border-bottom:1px solid var(--border)}
.msg-bubble tr:hover td{background:rgba(255,255,255,0.02)}
.msg-bubble h1,.msg-bubble h2,.msg-bubble h3{font-size:15px;font-weight:700;margin:16px 0 8px;color:var(--text)}
.msg-bubble blockquote{border-left:3px solid var(--accent);padding-left:12px;color:var(--text2);margin:10px 0}
.citation{display:inline-block;background:var(--accent-dim);color:var(--accent);padding:2px 8px;
  border-radius:20px;font-size:11px;font-weight:600;margin:0 2px;vertical-align:middle}

/* Copy button */
.msg-copy{position:absolute;top:8px;right:8px;background:var(--bg2);border:1px solid var(--border);
  border-radius:6px;padding:4px 8px;font-size:11px;color:var(--text2);cursor:pointer;opacity:0;transition:all .2s;
  font-family:var(--font)}
.msg.bot:hover .msg-copy{opacity:1}
.msg-copy:hover{background:var(--surface2);color:var(--text)}

/* Typing indicator */
.typing{display:flex;gap:4px;padding:4px 0}
.typing span{width:6px;height:6px;background:var(--text3);border-radius:50%;animation:bounce .6s infinite alternate}
.typing span:nth-child(2){animation-delay:.2s}
.typing span:nth-child(3){animation-delay:.4s}
@keyframes bounce{to{opacity:0.3;transform:translateY(-4px)}}

/* INPUT */
.input-wrap{position:fixed;bottom:0;left:0;right:0;padding:16px 20px 20px;background:linear-gradient(transparent,var(--bg) 30%)}
.input-inner{max-width:780px;margin:0 auto;display:flex;gap:10px}
.input-field{flex:1;padding:14px 18px;background:var(--surface);border:1px solid var(--border);
  border-radius:12px;color:var(--text);font-family:var(--font);font-size:14px;outline:none;transition:border .2s;
  resize:none;max-height:120px;line-height:1.5}
.input-field:focus{border-color:var(--accent)}
.input-field::placeholder{color:var(--text3)}
.send-btn{width:46px;height:46px;background:var(--accent);border:none;border-radius:12px;color:#fff;
  font-size:18px;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.send-btn:hover{background:#0da572;transform:translateY(-1px)}
.send-btn:disabled{opacity:0.4;cursor:not-allowed;transform:none}

@media(max-width:600px){
  .header{padding:12px 16px}
  .chat-inner{padding:16px 14px 110px}
  .welcome{padding:40px 0 24px}
  .suggestions{grid-template-columns:1fr}
  .msg.user .msg-bubble,.msg.bot .msg-bubble{max-width:90%}
  .input-wrap{padding:10px 12px 14px}
}
</style>
</head>
<body>
<!-- LOGIN -->
<div id="login-screen">
  <div class="login-box">
    <div class="login-logo">üèõ</div>
    <div class="login-title">CMHC Policy Assistant</div>
    <div class="login-tagline">AI powered CMHC policy intelligence<br>for mortgage professionals</div>
    <input type="password" id="pw" class="login-input" placeholder="Enter access password" autofocus>
    <button id="login-btn" class="login-btn" onclick="doLogin()">Sign In</button>
    <div id="login-err" class="login-error"></div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div class="header">
    <div class="header-brand">
      <div class="header-icon">üèõ</div>
      <div class="header-name">CMHC Policy Assistant</div>
    </div>
    <button class="header-btn" onclick="newChat()">+ New Chat</button>
  </div>
  <div class="chat-wrap" id="chat-wrap">
    <div class="chat-inner" id="chat"></div>
  </div>
  <div class="input-wrap">
    <div class="input-inner">
      <textarea id="input" class="input-field" placeholder="Ask about CMHC policies..." rows="1"
        onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();send()}"></textarea>
      <button class="send-btn" id="send-btn" onclick="send()">‚Üë</button>
    </div>
  </div>
</div>

<script>
const API_BASE='https://hardwood-input-patterns-guitar.trycloudflare.com';
let token=localStorage.getItem('cmhc_token')||'';
let messages=JSON.parse(localStorage.getItem('cmhc_history')||'[]');
let streaming=false;

// Auto-login if token exists
if(token){showApp();renderAll()}

document.getElementById('pw').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin()});

async function doLogin(){
  const pw=document.getElementById('pw').value.trim();
  if(!pw)return;
  const err=document.getElementById('login-err');
  err.textContent='';
  try{
    const r=await fetch(API_BASE+'/api/auth',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({password:pw})});
    const d=await r.json();
    if(d.ok){token=d.token;localStorage.setItem('cmhc_token',token);showApp();renderAll()}
    else{err.textContent='Invalid password'}
  }catch(e){err.textContent='Connection error. Please try again.'}
}

function showApp(){
  document.getElementById('login-screen').classList.add('login-hide');
  document.getElementById('app').classList.add('active');
}

function saveHistory(){localStorage.setItem('cmhc_history',JSON.stringify(messages))}

function newChat(){messages=[];localStorage.removeItem('cmhc_history');renderAll()}

const SUGGESTIONS=[
  {icon:'‚úÖ',title:'Eligibility Requirements',desc:'Who qualifies for CMHC multi unit insurance?',q:'What are the eligibility requirements for CMHC multi-unit mortgage loan insurance?'},
  {icon:'üí∞',title:'Premium Rates',desc:'Current insurance premium schedules',q:'What are the current CMHC multi-unit premium rates?'},
  {icon:'üèó',title:'ACLP Overview',desc:'Apartment Construction Loan Program details',q:'Can you give me an overview of the CMHC Apartment Construction Loan Program (ACLP)?'},
  {icon:'üìä',title:'LTV Ratios',desc:'Maximum loan to value requirements',q:'What are the maximum LTV ratios for CMHC insured multi-unit properties?'},
  {icon:'üåø',title:'MLI Select',desc:'Energy efficiency incentives and discounts',q:'How does the MLI Select program work and what are the premium discounts?'},
  {icon:'üî®',title:'Construction Financing',desc:'Progress advance and completion requirements',q:'What are CMHC requirements for construction financing and progress advances?'}
];

function renderAll(){
  const chat=document.getElementById('chat');
  if(messages.length===0){
    chat.innerHTML=`<div class="welcome"><h2>How can I help you today?</h2><p>Ask any question about CMHC multi unit insurance policies</p><div class="suggestions">${SUGGESTIONS.map(s=>`<div class="sug-card" onclick="sendQ('${s.q.replace(/'/g,"\\'")}')"><div class="sug-icon">${s.icon}</div><div class="sug-title">${s.title}</div><div class="sug-desc">${s.desc}</div></div>`).join('')}</div></div>`;
    return;
  }
  chat.innerHTML=messages.map((m,i)=>{
    if(m.role==='user')return`<div class="msg user"><div class="msg-bubble">${esc(m.content)}</div></div>`;
    return`<div class="msg bot"><div class="msg-bubble">${renderMd(m.content)}<button class="msg-copy" onclick="copyMsg(${i})">Copy</button></div></div>`;
  }).join('');
  scrollDown();
}

function sendQ(q){document.getElementById('input').value=q;send()}

async function send(){
  if(streaming)return;
  const inp=document.getElementById('input');
  const text=inp.value.trim();
  if(!text)return;
  inp.value='';inp.style.height='auto';
  messages.push({role:'user',content:text});
  saveHistory();renderAll();

  streaming=true;
  document.getElementById('send-btn').disabled=true;

  // Add bot placeholder
  const chat=document.getElementById('chat');
  const botDiv=document.createElement('div');botDiv.className='msg bot';
  botDiv.innerHTML='<div class="msg-bubble"><div class="typing"><span></span><span></span><span></span></div></div>';
  chat.appendChild(botDiv);scrollDown();

  let botText='';
  try{
    const r=await fetch(API_BASE+'/api/chat',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},
      body:JSON.stringify({message:text,history:messages.slice(-7,-1)})});
    if(r.status===401){localStorage.removeItem('cmhc_token');location.reload();return}
    const reader=r.body.getReader();const dec=new TextDecoder();let buf='';
    while(true){
      const{done,value}=await reader.read();
      if(done)break;
      buf+=dec.decode(value,{stream:true});
      const lines=buf.split('\n');buf=lines.pop();
      for(const line of lines){
        if(line.startsWith('data: ')&&line.slice(6).trim()!=='[DONE]'){
          try{const d=JSON.parse(line.slice(6));if(d.text)botText+=d.text;if(d.error)botText+=d.error}catch{}
        }
      }
      botDiv.innerHTML=`<div class="msg-bubble">${renderMd(botText)}<button class="msg-copy" onclick="copyMsg(${messages.length})">Copy</button></div>`;
      scrollDown();
    }
  }catch(e){botText=botText||'Connection error. Please try again.'}

  messages.push({role:'assistant',content:botText});
  saveHistory();streaming=false;
  document.getElementById('send-btn').disabled=false;
  renderAll();
}

function scrollDown(){const w=document.getElementById('chat-wrap');w.scrollTop=w.scrollHeight}

function copyMsg(i){
  const t=messages[i]?.content||'';
  navigator.clipboard.writeText(t).then(()=>{
    const btns=document.querySelectorAll('.msg-copy');
    btns.forEach(b=>{if(b.closest('.msg')===document.querySelectorAll('.msg')[i]){b.textContent='Copied!';setTimeout(()=>b.textContent='Copy',1500)}});
  });
}

function esc(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

function renderMd(s){
  if(!s)return'';
  s=esc(s);
  // Citations like [Source: xxx] or [Document: xxx]
  s=s.replace(/\[(Source|Document|File|Ref)[:\s]+([^\]]+)\]/gi,'<span class="citation">$1: $2</span>');
  // Headers
  s=s.replace(/^### (.+)$/gm,'<h3>$1</h3>');
  s=s.replace(/^## (.+)$/gm,'<h2>$1</h2>');
  s=s.replace(/^# (.+)$/gm,'<h1>$1</h1>');
  // Bold/italic
  s=s.replace(/\*\*\*(.+?)\*\*\*/g,'<strong><em>$1</em></strong>');
  s=s.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  s=s.replace(/\*(.+?)\*/g,'<em>$1</em>');
  // Code blocks
  s=s.replace(/```[\w]*\n([\s\S]*?)```/g,'<pre><code>$1</code></pre>');
  s=s.replace(/`([^`]+)`/g,'<code>$1</code>');
  // Tables
  s=s.replace(/^(\|.+\|)\n\|[\s\-:|]+\|\n((?:\|.+\|\n?)*)/gm,(m,hdr,rows)=>{
    const ths=hdr.split('|').filter(c=>c.trim()).map(c=>`<th>${c.trim()}</th>`).join('');
    const trs=rows.trim().split('\n').map(r=>{
      const tds=r.split('|').filter(c=>c.trim()).map(c=>`<td>${c.trim()}</td>`).join('');
      return`<tr>${tds}</tr>`;
    }).join('');
    return`<table><thead><tr>${ths}</tr></thead><tbody>${trs}</tbody></table>`;
  });
  // Blockquotes
  s=s.replace(/^&gt; (.+)$/gm,'<blockquote>$1</blockquote>');
  // Lists
  s=s.replace(/^[\-\*] (.+)$/gm,'<li>$1</li>');
  s=s.replace(/^(\d+)\. (.+)$/gm,'<li>$2</li>');
  s=s.replace(/((?:<li>.+<\/li>\n?)+)/g,'<ul>$1</ul>');
  // Line breaks to paragraphs
  s=s.replace(/\n\n+/g,'</p><p>');
  s=s.replace(/\n/g,'<br>');
  s='<p>'+s+'</p>';
  s=s.replace(/<p><\/p>/g,'');
  return s;
}

// Auto-resize textarea
document.getElementById('input').addEventListener('input',function(){this.style.height='auto';this.style.height=Math.min(this.scrollHeight,120)+'px'});
</script>
</body>
</html>
